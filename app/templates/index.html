{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
{% endblock %}

{% block app_content %}
  <h1>All donations</h1>
  <form action="/" method="POST">
    {{ form.csrf_token }}
    <div class="row">
      <div class="col-4">
        <strong>Recipients</strong><br>
        {{ form.recipient_labour_party.label }} {{ form.recipient_labour_party(size=20) }} <br>
        {{ form.recipient_conservative_and_unionist_party.label }} {{ form.recipient_conservative_and_unionist_party(size=20) }} <br>
        {{ form.recipient_liberal_democrats.label }} {{ form.recipient_liberal_democrats(size=20) }} <br>
        <strong>Legacy</strong><br>
        {{ form.is_legacy_true.label }} {{ form.is_legacy_true(size=20) }} <br>
        {{ form.is_legacy_false.label }} {{ form.is_legacy_false(size=20) }} <br>
        <strong>Dates</strong><br>
        {{ form.date_gt.label }} {{ form.date_gt(size=20) }} <br>
        {{ form.date_lt.label }} {{ form.date_lt(size=20) }} <br>
      </div>
      <div class="col-4">
        <strong>Donor types</strong><br>
        {{ form.donor_type_individual.label }} {{ form.donor_type_individual(size=20) }} <br>
        {{ form.donor_type_company.label }} {{ form.donor_type_company(size=20) }} <br>
        {{ form.donor_type_trade_union.label }} {{ form.donor_type_trade_union(size=20) }} <br>
        {{ form.donor_type_unincorporated_association.label }} {{
        form.donor_type_unincorporated_association(size=20) }} <br>
        {{ form.donor_type_other.label }} {{ form.donor_type_other(size=20) }} <br>
        {{ form.donor_type_building_society.label }} {{ form.donor_type_building_society(size=20) }} <br>
        {{ form.donor_type_public_fund.label }} {{ form.donor_type_public_fund(size=20) }} <br>
        {{ form.donor_type_limited_liability_partnership.label }} {{
        form.donor_type_limited_liability_partnership(size=20) }} <br>
        {{ form.donor_type_trust.label }} {{ form.donor_type_trust(size=20) }} <br>
        {{ form.donor_type_friendly_society.label }} {{ form.donor_type_friendly_society(size=20) }} <br>
        {{ form.donor_type_impermissible_donor.label }} {{ form.donor_type_impermissible_donor(size=20) }} <br>
        {{ form.donor_type_na.label }} {{ form.donor_type_na(size=20) }} <br>
        {{ form.donor_type_unidentifiable_donor.label }} {{
        form.donor_type_unidentifiable_donor(size=20) }} <br>
      </div>
      <div class="col-4">
        <strong>Donation types</strong><br>
        {{ form.donation_type_cash.label }} {{ form.donation_type_cash(size=20) }} <br>
        {{ form.donation_type_non_cash.label }} {{ form.donation_type_non_cash(size=20) }} <br>
        {{ form.donation_type_visit.label }} {{ form.donation_type_visit(size=20) }} <br>
        {{ form.donation_type_public_funds.label }} {{ form.donation_type_public_funds(size=20) }} <br>
        {{ form.donation_type_exempt_trust.label }} {{ form.donation_type_exempt_trust(size=20) }} <br>
        {{ form.donation_type_permissible_donor_exempt_trust.label }} {{ form.donation_type_permissible_donor_exempt_trust(size=20) }} <br> 
        {{ form.donation_type_impermissible_donor.label }} {{ form.donation_type_impermissible_donor(size=20) }} <br>
        {{ form.donation_type_unidentified_donor.label }} {{ form.donation_type_unidentified_donor(size=20) }} <br>

      </div>
      <div class="col">
    </div>
    {{ form.submit() }}
  </form>
  <div id="table"></div>
{% endblock %}

{% block scripts %}
  <script type="module">
    import {
      Grid,
      html
    } from "https://unpkg.com/gridjs?module";
    const updateUrl = (prev, query) => {
      // Check if "?" exists in the prev string. If so, find its position. If that
      // position is >= 0, append &, otherwise append ?
      return prev + (prev.indexOf("?") >= 0 ? "&" : "?") + new URLSearchParams(query).toString();
    };
    const currencyFormatter = (value) => new Intl.NumberFormat(
      'en-GB', 
      { 
        style: 'currency', 
        currency: 'GBP', 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }
    ).format(value);
    const dateFormatter = (value) => {
      const timestamp = new Date(value);
      const day = timestamp.getUTCDate().toString().padStart(2, '0');
      const month = (timestamp.getUTCMonth() + 1).toString().padStart(2, '0');
      const year = timestamp.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }
    const recipientFormatter = (value) => {
      if (value == "Conservative and Unionist Party") {return "Conservative Party";}
      if (value == "UK Independence Party (UKIP)") {return "UKIP";}
      if (value == "Scottish National Party (SNP)") {return "SNP";}
      return value;
    }
    const donorTypeFormatter = (value) => {
      if (value == "Limited Liability Partnership") {return "LLP";}
      return value;
    }

    // Adjust tickboxes and date fields to match filters in api_filter template variable
    window.onload = function() {
      const regex = /filter\=([^&]+?)(?:&|$)/g;
      const recipientFilters = [];
      let match;
      while ((match = regex.exec("{{ api_filter }}")) !== null) {
        recipientFilters.push(match[1]);
      }
      if (recipientFilters.length > 0) {
        for (var filter of recipientFilters) {
          if (filter.startsWith("date_gt")) {
            var startDateField = document.getElementById("date_gt")
            startDateField.value = filter.slice(-10)
          } else if (filter.startsWith("date_lt")) {
            var endDateField = document.getElementById("date_lt")
            endDateField.value = filter.slice(-10)
          } else {
            document.querySelector(`input[name="${filter}"]`).checked = true;
          }
        }
      } else {
        document.querySelectorAll('input').forEach(function(checkbox) {
          checkbox.checked = true;
        });
      }
    };

    new Grid({
      columns: [
        { id: 'donor', name: 'Donor', formatter: (cell) => html(`${cell}`) },
        { id: 'donor_type', name: 'Donor Type', formatter: (cell) => donorTypeFormatter(cell)},
        { id: 'recipient', name: 'Recipient', formatter: (cell) => recipientFormatter(cell) },
        { id: 'date', name: 'Date', formatter: (cell) => dateFormatter(cell) },
        { id: 'type', name: 'Donation Type' },
        { id: 'amount', name: 'Amount', formatter: (cell) => currencyFormatter(cell) },
        { 
          id: 'legacy', 
          name: 'Legacy', 
          formatter: function (cell) { 
            return cell ? "✅" : "❌";
          }
        },
      ],
      server: {
        url: '/api/data?{{ api_filter|safe }}',
        then: results => results.data,
        total: results => results.total,
      },
      search: {
        enabled: true,
        server: {
          url: (prev, search) => {
            return updateUrl(prev, {search});
          },
        },
      },
      sort: {
        enabled: true,
        multiColumn: true,
        server: {
          url: (prev, columns) => {
            const columnIds = ["donor", "donor_type", "recipient", "date", "type", "value"]
            const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
            return updateUrl(prev, {sort});
          },
        },
      },
      pagination: {
        enabled: true,
        limit: 100,
        server: {
          url: (prev, page, limit) => {
            return updateUrl(prev, {start: page * limit, length: limit})
          },
        },
      },
      resizable: true,
    }).render(document.getElementById('table'));
  </script>

{% endblock %}
